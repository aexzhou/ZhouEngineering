<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projects</title>
    <link rel="icon" type="image/x-icon" href="./images/favicon.ico?v=2">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Liu+Jian+Mao+Cao:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <link href="styles/base.css" rel="stylesheet">
    <link href="styles/layout.css" rel="stylesheet">
    <link href="styles/components.css" rel="stylesheet">
    <link href="styles/projects.css" rel="stylesheet">
    <link href="styles/utilities.css" rel="stylesheet">
    <link href="styles/animations.css" rel="stylesheet">

    <!-- syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script>

</head>
<body>

<div class="navigation">
    <h1 id="name"><span>Alex Zhou</span> <span class="chinese2">周勤楠</span></h1>
    <ul>
        <li><a href="./">Home</a></li>
        <li><a href="projects">Projects</a></li>
        <li><a href="./#about">About</a></li>
        <li><a href="./#skills">Skills</a></li>
        <li><a href="./#contact">Contact</a></li>
    </ul>
</div>

<div class="sidebar"> 
    <h2 onclick="goToPage('projects.html')">PROJECT DIRECTORY</h2>
    <div id="directory-tree"></div>

</div>

<div class="content-navigation"></div>

<div id="markdown-content"></div>

<div class="footer">
    <p>Qinnan Zhou &copy; 2024</p>
</div>


<!-- MARKDOWN CSS -->
<style>
#markdown-content{
    width: 50%;
    max-width: 800px;
    margin: 20px auto;
}

#markdown-content h1, #markdown-content h3 {
    color: #333;
    padding: 10px 0;
}

#markdown-content h2 {
    padding: 5px 0;
    font-size: 24px;
}

#markdown-content p {
    line-height: 1.5;
    font-size: 18px;
    font-family: 'Noto Sans', sans-serif;
}

#markdown-content pre {
    position: relative;
    background-color: #282c34;
    color: #eee;
    padding: 15px;
    font-family: 'JetBrainsMono-Regular';
    overflow-x: auto;
    border-color:  transparent;
    border-radius: 10px;
    font-size: 16px;
    margin-top: 20px;
}

.code-lang-indicator {
    position: absolute;
    top: 0;
    right: 0;
    background-color: #000000;
    color: #fff;
    padding: 2px 8px;
    font-size: 0.75em;
    border-bottom-left-radius: 4px; 
}

#markdown-content img {
    display: block;
    max-width: 100%;
    height: auto;
    margin-left: auto;
    margin-right: auto;
    border: 2px solid #000;
    border-radius: 20px;
}

#markdown-content iframe{
    display: block;
    margin: auto;
}

.sidebar h2{
    font-size: 26px;
    color: #fff;
    padding: 10px;
    background-color: #5b5b5b;
    text-align: center;
    border-radius: 10px;
} 
</style>

<!-- MARKDOWN & JSON PARSING JAVASCRIPT -->
<script src="https://cdn.bootcss.com/marked/0.3.6/marked.min.js" charset="utf-8"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js" charset="utf-8"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/languages/javascript.min.js" charset="utf-8"></script>
<script src="scripts/md_html.min.js" charset="utf-8"></script>
<script type="text/javascript">
  markedInHtml.init()
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        fetch('directoryStructure.json')
            .then(response => response.json())
            .then(data => {
                const treeHtml = createTree(data);
                document.getElementById('directory-tree').innerHTML = treeHtml;

                const params = new URLSearchParams(window.location.search);
                const projectID = params.get('projectID');
                if (projectID){
                    const markdownFile = findMarkdownFile(data, projectID);
                    if (markdownFile) {
                        loadMarkdown(markdownFile);
                    }else{
                        console.log("Markdown file not found for ID:", projectID);
                        loadMarkdown('utilities/page-not-found.md');
                    }
                }else{
                    loadDefaultMarkdown();
                }
            })
            .catch(error => console.error('Failed to load directory structure:', error));
    });

    function loadDefaultMarkdown() {
        loadMarkdown('project-home.md'); // Default md
    }

    function findMarkdownFile(data, id) {
        // Does recursive search thru data tree
        for (const item of data) {
            if (item.type === "folder" && item.children) {
                const result = findMarkdownFile(item.children, id);
                if (result) return result;
            } else if (item.type === "file" && item.id === id) {
                return item.path;  
            }
        }

        return null;  
    }

    function renderMarkdown(template) {
        console.log(template.content.textContent);
        const renderedHtml = marked(template.content.textContent);
        document.getElementById('markdown-content').innerHTML = renderedHtml;
    }

    // For building the html from data structure 
    function createTree(data) {
        let html = "<ul>";
        data.forEach(item => {
            if (item.type === "folder") {
                html += `<li class="folder-item">
                        <span class="folder-name" onclick="toggleFolderVisibility(this)">
                            <i class="icon-folder-closed"></i> 
                            <span class="folder-text">${item.name}</span>
                        </span>
                        <ul class="folder-content">`;
                html += createTree(item.children);
                html += `</ul>
                        </li>`;
            } else if (item.type === "file") {
                html += `<li class="file-item">
                        <a href="#" onclick="loadMarkdown('${item.path}')">
                            <i class="icon-file"></i> 
                            <span>${item.name}</span>
                        </a>
                    </li>`;
            }
        });
        html += "</ul>";
        return html;
    }

    function toggleFolderVisibility(element) {
        const folderContent = element.parentNode.querySelector('.folder-content');
        const icon = element.querySelector('i');  // icon is an <i> element

        if (folderContent.style.display === "none" || folderContent.style.display === "") {
            folderContent.style.display = "block";
            icon.classList.remove('icon-folder-closed');
            icon.classList.add('icon-folder-open');
        } else {
            folderContent.style.display = "none";
            icon.classList.remove('icon-folder-open');
            icon.classList.add('icon-folder-closed');
        }
    }

    function loadMarkdown(path) {
        fetch(path)
            .then(response => response.text())
            .then(text => {
                document.getElementById('markdown-content').innerHTML = marked(text);
                addLanguageIndicators();
                generateContentNavigation();
            })
            .catch(err => console.error('Error loading the markdown file:', err));
    }

    function addLanguageIndicators() {
        document.querySelectorAll('pre code').forEach((block) => {
            const langName = block.classList[0]; // 'language-xyz' format, typically used by highlight.js
            if (langName) {
                const formattedLangName = formatLanguageName(langName);
                const label = document.createElement('div');
                label.className = 'code-lang-indicator';
                label.textContent = formattedLangName;
                block.parentNode.insertBefore(label, block);
                // console.log("Adding label for:", formattedLangName);
            }
        });
    }

    function formatLanguageName(langName) {
        return langName.replace('language-', '').toUpperCase(); // Adjust formatting as needed
    }

    function generateContentNavigation() {
        const headers = document.querySelectorAll('#markdown-content h2, #markdown-content h3, #markdown-content h4');
        let navHtml = "<ul>";
        let openH3List = false;  // Track whether we are within an h2 element's h3 list
        let openH4List = false;  // Track whether we are within an h3 element's h4 list

        headers.forEach(header => {
            const id = header.innerText.toLowerCase().replace(/\s+/g, '-');
            header.id = id;
            
            if (header.tagName.toLowerCase() === 'h2') {
                if (openH4List) { // Close previous h4 list if it was open
                    navHtml += "</ul></li>";
                    openH4List = false;
                }
                if (openH3List) { // Close previous h3 list if it was open
                    navHtml += "</ul></li>";
                    openH3List = false;
                }
                navHtml += `<li class="h2"><a href="#${id}">${header.innerText}</a>`;
            } else if (header.tagName.toLowerCase() === 'h3') {
                if (openH4List) { // Close previous h4 list if it was open
                    navHtml += "</ul></li>";
                    openH4List = false;
                }
                if (!openH3List) { // If h3 list isn't open, start it
                    navHtml += "<ul>";
                    openH3List = true;
                }
                navHtml += `<li class="h3"><a href="#${id}">${header.innerText}</a>`;
            } else if (header.tagName.toLowerCase() === 'h4') {
                if (!openH4List) { // If h4 list isn't open, start it
                    navHtml += "<ul>";
                    openH4List = true;
                }
                navHtml += `<li class="h4"><a href="#${id}">${header.innerText}</a></li>`;
            }
        });

        if (openH4List) { // Close the last h4 list if it was open
            navHtml += "</ul></li>";
            openH4List = false;
        }
        if (openH3List) { // Close the last h3 list if it was open
            navHtml += "</ul></li>";
            openH3List = false;
        }

        navHtml += "</ul>"; // Close the main list
        document.querySelector('.content-navigation').innerHTML = navHtml;
    }

</script>

<script src="script.js"></script>
</body>
</html>
